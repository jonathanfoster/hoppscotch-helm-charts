# yamllint disable rule:line-length
suite: Secret Database
templates:
  - config/secret.yaml
tests:
  - it: should set database config to postgresql auth values
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: true
        auth:
          username: postgresql-user
          password: postgresql-password
          database: postgresql-db
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://postgresql-user:postgresql-password@RELEASE-NAME-postgresql.NAMESPACE.svc.cluster.local:5432/postgresql-db
          decodeBase64: true

  - it: should set database config to postgresql auth values with default secret
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: true
        auth:
          username: postgresql-user
          password: ""
          database: postgresql-db
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: RELEASE-NAME-postgresql
            namespace: NAMESPACE
          data:
            # echo -n postgresql-password | base64
            password: cG9zdGdyZXNxbC1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://postgresql-user:postgresql-password@RELEASE-NAME-postgresql.NAMESPACE.svc.cluster.local:5432/postgresql-db
          decodeBase64: true

  - it: should set database config to postgresql auth values with existing secret
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: true
        auth:
          username: postgresql-user
          password: ""
          database: postgresql-db
          existingSecret: postgresql-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: postgresql-secret
            namespace: NAMESPACE
          data:
            # echo -n postgresql-password | base64
            password: cG9zdGdyZXNxbC1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://postgresql-user:postgresql-password@RELEASE-NAME-postgresql.NAMESPACE.svc.cluster.local:5432/postgresql-db
          decodeBase64: true

  - it: should set database config to postgresql auth values with existing secret and key
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: true
        auth:
          username: postgresql-user
          password: ""
          database: postgresql-db
          existingSecret: postgresql-secret
          secretKeys:
            userPasswordKey: postgresql-password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: postgresql-secret
            namespace: NAMESPACE
          data:
            # echo -n postgresql-password | base64
            postgresql-password: cG9zdGdyZXNxbC1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://postgresql-user:postgresql-password@RELEASE-NAME-postgresql.NAMESPACE.svc.cluster.local:5432/postgresql-db
          decodeBase64: true

  - it: should set database config to external database values
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        host: external-postgres
        port: 5432
        user: external-user
        password: external-password
        database: external-db
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:5432/external-db
          decodeBase64: true

  - it: should set database config to external database values with default port
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        host: external-postgres
        user: external-user
        password: external-password
        database: external-db
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:5432/external-db
          decodeBase64: true

  - it: should set database config to external database values with custom port
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        host: external-postgres
        port: 1234
        user: external-user
        password: external-password
        database: external-db
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:1234/external-db
          decodeBase64: true

  - it: should set database config to external database sql connection
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        sqlConnection: postgresql://hoppscotch-external-sql-user:hoppscotch-external-sql-password@hoppscotch-external-sql-host:54325/hoppscotch-external-sql-db
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgresql://hoppscotch-external-sql-user:hoppscotch-external-sql-password@hoppscotch-external-sql-host:54325/hoppscotch-external-sql-db
          decodeBase64: true

  - it: should set database config to external database values with existing secret
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        host: external-postgres
        user: external-user
        database: external-db
        existingSecret: external-db-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: external-db-secret
            namespace: NAMESPACE
          data:
            # echo -n external-password | base64
            password: ZXh0ZXJuYWwtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:5432/external-db
          decodeBase64: true

  - it: should set database config to external database values with existing secret and key
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        host: external-postgres
        user: external-user
        database: external-db
        existingSecret: external-db-secret
        existingSecretPasswordKey: external-db-password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: external-db-secret
            namespace: NAMESPACE
          data:
            # echo -n external-password | base64
            external-db-password: ZXh0ZXJuYWwtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:5432/external-db
          decodeBase64: true

  - it: should set database config to external database existing secret sql connection
    set:
      hoppscotch:
        backend:
          databaseUrl: ""
      postgresql:
        enabled: false
      externalDatabase:
        existingSecret: external-db-secret
        existingSecretSqlConnectionKey: external-db-sql-connection
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: external-db-secret
            namespace: NAMESPACE
          data:
            # echo -n postgres://external-user:external-password@external-postgres:5432/external-db | base64
            external-db-sql-connection: cG9zdGdyZXM6Ly9leHRlcm5hbC11c2VyOmV4dGVybmFsLXBhc3N3b3JkQGV4dGVybmFsLXBvc3RncmVzOjU0MzIvZXh0ZXJuYWwtZGI=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATABASE_URL
          value: postgres://external-user:external-password@external-postgres:5432/external-db
          decodeBase64: true
