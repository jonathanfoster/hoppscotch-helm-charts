suite: Secret ClickHouse
templates:
  - config/secret.yaml
tests:
  - it: should set clickhouse config to clickhouse auth values
    set:
      clickhouse:
        enabled: true
        auth:
          username: clickhouse-user
          password: clickhouse-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to clickhouse auth values with default secret
    set:
      clickhouse:
        enabled: true
        auth:
          username: clickhouse-user
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: RELEASE-NAME-clickhouse
            namespace: NAMESPACE
          data:
            # echo -n clickhouse-password | base64
            admin-password: Y2xpY2tob3VzZS1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to clickhouse auth values with existing secret
    set:
      clickhouse:
        enabled: true
        auth:
          username: clickhouse-user
          existingSecret: clickhouse-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: clickhouse-secret
            namespace: NAMESPACE
          data:
            # echo -n clickhouse-password | base64
            admin-password: Y2xpY2tob3VzZS1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to clickhouse auth values with existing secret and key
    set:
      clickhouse:
        enabled: true
        auth:
          username: clickhouse-user
          existingSecret: clickhouse-secret
          existingSecretKey: clickhouse-password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: clickhouse-secret
            namespace: NAMESPACE
          data:
            # echo -n clickhouse-password | base64
            clickhouse-password: Y2xpY2tob3VzZS1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to external clickhouse values
    set:
      externalClickhouse:
        user: clickhouse-user
        password: clickhouse-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to external clickhouse values with existing secret
    set:
      externalClickhouse:
        user: clickhouse-user
        existingSecret: clickhouse-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: clickhouse-secret
            namespace: NAMESPACE
          data:
            # echo -n clickhouse-password | base64
            password: Y2xpY2tob3VzZS1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true

  - it: should set clickhouse config to external clickhouse values with existing secret and key
    set:
      externalClickhouse:
        user: clickhouse-user
        existingSecret: clickhouse-secret
        existingSecretPasswordKey: clickhouse-password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: clickhouse-secret
            namespace: NAMESPACE
          data:
            # echo -n clickhouse-password | base64
            clickhouse-password: Y2xpY2tob3VzZS1wYXNzd29yZA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.CLICKHOUSE_USER
          value: clickhouse-user
          decodeBase64: true
      - equal:
          path: data.CLICKHOUSE_PASSWORD
          value: clickhouse-password
          decodeBase64: true
