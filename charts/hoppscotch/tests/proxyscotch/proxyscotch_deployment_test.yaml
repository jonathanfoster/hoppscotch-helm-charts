suite: Proxyscotch Deployment
templates:
  - proxyscotch/deployment.yaml
  - proxyscotch/configmap.yaml
tests:
  - it: should generate deployment when proxyscotch is enabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment

  - it: should not generate deployment when proxyscotch is disabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should set name
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
          name: release-name-hoppscotch-proxyscotch

  - it: should set namespace
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should set component label
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: proxyscotch

  - it: should set hoppscotch labels
    template: proxyscotch/deployment.yaml
    chart:
      version: 0.0.0
      appVersion: 0.0.0
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: hoppscotch
      - equal:
          path: metadata.labels["app.kubernetes.io/part-of"]
          value: hoppscotch
      - equal:
          path: metadata.labels["app.kubernetes.io/version"]
          value: 0.0.0
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: hoppscotch-0.0.0

  - it: should set common annotations
    set:
      commonAnnotations:
        test: test
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: metadata.annotations["test"]
          value: test

  - it: should set replicas when autoscaling is disabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        replicaCount: 1
        autoscaling:
          enabled: false
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should set update strategy when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        updateStrategy:
          type: RollingUpdate
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate

  - it: should set label selector component match labels
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/component"]
          value: proxyscotch

  - it: should set label selector hoppscotch match labels
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: hoppscotch

  - it: should set pod template configmap checksum annotation
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - matchRegex:
          path: spec.template.metadata.annotations["checksum/configmap-release-name-hoppscotch-proxyscotch"]
          pattern: ^[a-fA-F0-9]{64}$ # SHA256 hash of configmap template

  - it: should set pod template pod annotations when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        podAnnotations:
          example.com/test: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["example.com/test"]
          value: "true"

  - it: should set pod template component label
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/component"]
          value: proxyscotch

  - it: should set pod template hoppscotch labels
    template: proxyscotch/deployment.yaml
    chart:
      version: 0.0.0
      appVersion: 0.0.0
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: hoppscotch
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/part-of"]
          value: hoppscotch
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/version"]
          value: 0.0.0
      - equal:
          path: spec.template.metadata.labels["helm.sh/chart"]
          value: hoppscotch-0.0.0

  - it: should set pod template labels when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        podLabels:
          example.com/test: "true"
    asserts:
      - equal:
          path: spec.template.metadata.labels["example.com/test"]
          value: "true"

  - it: should set pod image pull secrets when specified
    template: proxyscotch/deployment.yaml
    set:
      global:
        imagePullSecrets:
          - name: test-registry-key
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: test-registry-key

  - it: should set pod service account name
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
      serviceAccount:
        create: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: release-name-hoppscotch

  - it: should set pod security context when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        podSecurityContext:
          runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should set pod container security context when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        securityContext:
          readOnlyRootFilesystem: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: should set pod container image
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        image:
          repository: hoppscotch/proxyscotch
          tag: v0.1.4
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: hoppscotch/proxyscotch:v0.1.4

  - it: should set pod container image pull policy
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        image:
          pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should set pod container http port
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        http: 9159
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9159

  - it: should set pod container custom liveness probe when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        customLivenessProbe:
          httpGet:
            path: /
            port: http
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: /
              port: http

  - it: should set pod container custom readiness probe when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        customReadinessProbe:
          httpGet:
            path: /
            port: http
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            httpGet:
              path: /
              port: http

  - it: should set pod container custom startup probe when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        customStartupProbe:
          httpGet:
            path: /
            port: http
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe
          value:
            httpGet:
              path: /
              port: http

  - it: should set pod container resources when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        resourcesPreset: small
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 500m
              ephemeral-storage: 2Gi
              memory: 512Mi
            requests:
              cpu: 250m
              ephemeral-storage: 50Mi
              memory: 256Mi

  - it: should set pod container data volume mount when persistence is enabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        persistence:
          enabled: true
          mountPath: /proxyscotch/data
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0]
          value:
            name: data
            mountPath: /proxyscotch/data

  - it: should set pod container volume mounts when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        volumeMounts:
          - name: custom-volume
            mountPath: /custom/path
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0]
          value:
            name: custom-volume
            mountPath: /custom/path

  - it: should set pod container extra env vars when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        extraEnvVars:
          - name: CUSTOM_ENV_VAR
            value: custom-env-var-value
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0]
          value:
            name: CUSTOM_ENV_VAR
            value: custom-env-var-value

  - it: should set pod container env from config map ref
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: release-name-hoppscotch-proxyscotch

  - it: should set pod container extra env vars configmap when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        extraEnvVarsCM: test-configmap
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].configMapRef.name
          value: test-configmap

  - it: should set pod container extra env vars secret when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        extraEnvVarsSecret: test-secret
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].secretRef.name
          value: test-secret

  - it: should set pod data volume when persistence is enabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        persistence:
          enabled: true
    asserts:
      - equal:
          path: spec.template.spec.volumes[0]
          value:
            name: data
            persistentVolumeClaim:
              claimName: release-name-hoppscotch-proxyscotch

  - it: should set pod data volume existing claim when specified given persistence is enabled
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        persistence:
          enabled: true
          existingClaim: test-claim
    asserts:
      - equal:
          path: spec.template.spec.volumes[0]
          value:
            name: data
            persistentVolumeClaim:
              claimName: test-claim

  - it: should set pod volume when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        volumes:
          - name: custom-volume
            emptyDir: {}
    asserts:
      - equal:
          path: spec.template.spec.volumes[0]
          value:
            name: custom-volume
            emptyDir: {}

  - it: should set pod node selector when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        nodeSelector:
          disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should set pod affinity when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: app.kubernetes.io/component
                        operator: In
                        values:
                          - proxyscotch
    asserts:
      - equal:
          path: spec.template.spec.affinity
          value:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: app.kubernetes.io/component
                          operator: In
                          values:
                            - proxyscotch

  - it: should set pod tolerations when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        tolerations:
          - key: key
            operator: Equal
            value: value
            effect: NoSchedule
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0]
          value:
            key: key
            operator: Equal
            value: value
            effect: NoSchedule

  - it: should set pod topology spread constraints when specified
    template: proxyscotch/deployment.yaml
    set:
      proxyscotch:
        enabled: true
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: proxyscotch
    asserts:
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0]
          value:
            maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: proxyscotch
