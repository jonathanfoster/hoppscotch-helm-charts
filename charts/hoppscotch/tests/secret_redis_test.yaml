# yamllint disable rule:line-length
suite: Secret Redis
templates:
  - config/secret.yaml
tests:
  - it: should set redis config to redis auth values
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: true
        auth:
          password: redis-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@RELEASE-NAME-redis-master.NAMESPACE.svc.cluster.local:6379
          decodeBase64: true

  - it: should set redis config to redis auth values with default secret
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: true
        auth:
          password: ""
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: RELEASE-NAME-redis
            namespace: NAMESPACE
          data:
            # echo -n redis-password | base64
            redis-password: cmVkaXMtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@RELEASE-NAME-redis-master.NAMESPACE.svc.cluster.local:6379
          decodeBase64: true

  - it: should set redis config to redis auth values with existing secret
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: true
        auth:
          password: ""
          existingSecret: redis-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: redis-secret
            namespace: NAMESPACE
          data:
            # echo -n redis-password | base64
            redis-password: cmVkaXMtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@RELEASE-NAME-redis-master.NAMESPACE.svc.cluster.local:6379
          decodeBase64: true

  - it: should set redis config to redis auth values and with existing secret and key
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: true
        auth:
          password: ""
          existingSecret: redis-secret
          existingSecretPasswordKey: password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: redis-secret
            namespace: NAMESPACE
          data:
            # echo -n redis-password | base64
            password: cmVkaXMtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@RELEASE-NAME-redis-master.NAMESPACE.svc.cluster.local:6379
          decodeBase64: true

  - it: should set redis config to external redis values
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: false
      externalRedis:
        host: external-redis
        port: 6379
        password: external-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:external-password@external-redis:6379
          decodeBase64: true

  - it: should set redis config to external redis values with default port
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: false
      externalRedis:
        host: external-redis
        password: external-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:external-password@external-redis:6379
          decodeBase64: true

  - it: should set redis config to external redis values with custom port
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: false
      externalRedis:
        host: external-redis
        port: 1234
        password: external-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:external-password@external-redis:1234
          decodeBase64: true

  - it: should set redis config to external redis values with existing secret
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: false
      externalRedis:
        host: external-redis
        password: ""
        existingSecret: redis-secret
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: redis-secret
            namespace: NAMESPACE
          data:
            # echo -n redis-password | base64
            redis-password: cmVkaXMtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@external-redis:6379
          decodeBase64: true

  - it: should set redis config to external redis values with existing secret and key
    set:
      hoppscotch:
        backend:
          redisUrl: ""
      redis:
        enabled: false
      externalRedis:
        host: external-redis
        password: ""
        existingSecret: redis-secret
        existingSecretPasswordKey: password
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: redis-secret
            namespace: NAMESPACE
          data:
            # echo -n redis-password | base64
            password: cmVkaXMtcGFzc3dvcmQ=
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.REDIS_URL
          value: redis://:redis-password@external-redis:6379
          decodeBase64: true
