suite: Secret
templates:
  - config/secret.yaml
tests:
  - it: should not create secret when existing secret is provided
    set:
      existingSecret: "my-existing-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should set jwt secret
    set:
      hoppscotch:
        backend:
          authToken:
            jwtSecret: hoppscotch-jwt-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.JWT_SECRET
          value: hoppscotch-jwt-secret
          decodeBase64: true

  - it: should generate jwt secret when empty
    set:
      hoppscotch:
        backend:
          authToken:
            jwtSecret: ""
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - matchRegex:
          path: data.JWT_SECRET
          # Match 64 random alphanumeric characters base64 encoded
          pattern: "^[a-zA-Z0-9]{64}$"
          decodeBase64: true

  - it: should set jwt secret with existing secret
    set:
      hoppscotch:
        backend:
          authToken:
            jwtSecret: ""
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: release-name-hoppscotch
            namespace: NAMESPACE
          data:
            # echo -n hoppscotch-jwt-secret | base64
            JWT_SECRET: aG9wcHNjb3RjaC1qd3Qtc2VjcmV0
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.JWT_SECRET
          value: hoppscotch-jwt-secret
          decodeBase64: true

  - it: should set session secret
    set:
      hoppscotch:
        backend:
          authToken:
            sessionSecret: hoppscotch-session-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.SESSION_SECRET
          value: hoppscotch-session-secret
          decodeBase64: true

  - it: should generate session secret when empty
    set:
      hoppscotch:
        backend:
          authToken:
            sessionSecret: ""
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - matchRegex:
          path: data.SESSION_SECRET
          pattern: "^[a-zA-Z0-9]{64}$"
          decodeBase64: true

  - it: should set session secret with existing secret
    set:
      hoppscotch:
        backend:
          authToken:
            sessionSecret: ""
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: release-name-hoppscotch
            namespace: NAMESPACE
          data:
            # echo -n hoppscotch-session-secret | base64
            SESSION_SECRET: aG9wcHNjb3RjaC1zZXNzaW9uLXNlY3JldA==
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.SESSION_SECRET
          value: hoppscotch-session-secret
          decodeBase64: true

  - it: should set data encryption key
    set:
      hoppscotch:
        backend:
          dataEncryptionKey: hoppscotch-data-encryption-key
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATA_ENCRYPTION_KEY
          value: hoppscotch-data-encryption-key
          decodeBase64: true

  - it: should generate data encryption key when empty
    set:
      hoppscotch:
        backend:
          dataEncryptionKey: ""
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - matchRegex:
          path: data.DATA_ENCRYPTION_KEY
          pattern: "^[a-zA-Z0-9]{32}$"
          decodeBase64: true

  - it: should set data encryption key with existing secret
    set:
      hoppscotch:
        backend:
          authToken:
            sessionSecret: ""
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: release-name-hoppscotch
            namespace: NAMESPACE
          data:
            # echo -n hoppscotch-data-encryption-key | base64
            DATA_ENCRYPTION_KEY: aG9wcHNjb3RjaC1kYXRhLWVuY3J5cHRpb24ta2V5
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.DATA_ENCRYPTION_KEY
          value: hoppscotch-data-encryption-key
          decodeBase64: true

  - it: should set github client config
    set:
      hoppscotch:
        backend:
          auth:
            github:
              clientId: hoppscotch-client-id
              clientSecret: hoppscotch-client-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.GITHUB_CLIENT_ID
          value: hoppscotch-client-id
          decodeBase64: true
      - equal:
          path: data.GITHUB_CLIENT_SECRET
          value: hoppscotch-client-secret
          decodeBase64: true

  - it: should set google client config
    set:
      hoppscotch:
        backend:
          auth:
            google:
              clientId: hoppscotch-client-id
              clientSecret: hoppscotch-client-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.GOOGLE_CLIENT_ID
          value: hoppscotch-client-id
          decodeBase64: true
      - equal:
          path: data.GOOGLE_CLIENT_SECRET
          value: hoppscotch-client-secret
          decodeBase64: true

  - it: should set microsoft client config
    set:
      hoppscotch:
        backend:
          auth:
            microsoft:
              clientId: hoppscotch-client-id
              clientSecret: hoppscotch-client-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.MICROSOFT_CLIENT_ID
          value: hoppscotch-client-id
          decodeBase64: true
      - equal:
          path: data.MICROSOFT_CLIENT_SECRET
          value: hoppscotch-client-secret
          decodeBase64: true

  - it: should set mailer config
    set:
      hoppscotch:
        backend:
          mailer:
            smtpUrl: smtp://smtp.example.com:587
            smtpUser: smtp-user
            smtpPassword: smtp-password
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.MAILER_SMTP_URL
          value: smtp://smtp.example.com:587
          decodeBase64: true
      - equal:
          path: data.MAILER_SMTP_USER
          value: smtp-user
          decodeBase64: true
      - equal:
          path: data.MAILER_SMTP_PASSWORD
          value: smtp-password
          decodeBase64: true

  - it: should set oidc client config
    set:
      hoppscotch:
        backend:
          auth:
            oidc:
              clientId: hoppscotch-client-id
              clientSecret: hoppscotch-client-secret
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.OIDC_CLIENT_ID
          value: hoppscotch-client-id
          decodeBase64: true
      - equal:
          path: data.OIDC_CLIENT_SECRET
          value: hoppscotch-client-secret
          decodeBase64: true

  - it: should set saml cert
    set:
      hoppscotch:
        backend:
          auth:
            saml:
              cert: hoppscotch-saml-cert
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.SAML_CERT
          value: hoppscotch-saml-cert
          decodeBase64: true

  - it: should set enterprise license key
    set:
      hoppscotch:
        backend:
          enterpriseLicenseKey: hoppscotch-enterprise-license-key
    asserts:
      - containsDocument:
          apiVersion: v1
          kind: Secret
      - equal:
          path: data.ENTERPRISE_LICENSE_KEY
          value: hoppscotch-enterprise-license-key
          decodeBase64: true
