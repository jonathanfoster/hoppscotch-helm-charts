suite: Frontend Deployment
templates:
  - frontend/deployment.yaml
  - config/configmap.yaml
  - config/secret.yaml
tests:
  - it: should generate deployment when deployment mode is distributed
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - hasDocuments:
          count: 1

  - it: should not generate deployment when deployment mode is aio
    template: frontend/deployment.yaml
    set:
      deploymentMode: aio
    asserts:
      - hasDocuments:
          count: 0

  - it: should use generated secret when existing secret is not specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: release-name-hoppscotch

  - it: should use existing secret when existing secret is specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      existingSecret: existing-secret
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: existing-secret
          any: true

  - it: should add extra env vars
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        extraEnvVars:
          - name: TEST_ENV_VAR
            value: test
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_ENV_VAR
            value: test
          any: true

  - it: should add extra env vars config map reference
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        extraEnvVarsCM: test-config-map
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: test-config-map
          any: true

  - it: should add extra env vars secret reference
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        extraEnvVarsSecret: test-secret
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: test-secret
          any: true

  - it: should use generated PVC when persistence is enabled
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        persistence:
          enabled: true
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            persistentVolumeClaim:
              claimName: release-name-hoppscotch-frontend
          any: true

  - it: should use existing PVC when persistence is enabled and existing PVC specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        persistence:
          enabled: true
          existingClaim: existing-pvc
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - contains:
          path: spec.template.spec.volumes
          content:
            persistentVolumeClaim:
              claimName: existing-pvc
          any: true

  - it: should generate readiness probe when enabled
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        readinessProbe:
          enabled: true
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.successThreshold
          value: 1
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 3

  - it: should not generate readiness probe when disabled
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        readinessProbe:
          enabled: false
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - notContains:
          path: spec.template.spec.containers[0].readinessProbe
          content: true

  - it: should use custom readiness probe when specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        customReadinessProbe:
          httpGet:
            path: /healthz
            port: 8080
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8080

  - it: should use custom startup probe when specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        customStartupProbe:
          httpGet:
            path: /healthz
            port: 8080
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: 8080

  - it: should set container image
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        image:
          repository: hoppscotch/hoppscotch-frontend
          tag: latest
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].image
          value: hoppscotch/hoppscotch-frontend:latest

  - it: should set container image tag to chart app version when tag is not specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        image:
          repository: hoppscotch/hoppscotch-frontend
          tag: ""
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ^hoppscotch/hoppscotch-frontend:[0-9]+\.[0-9]+\.[0-9]+$

  - it: should set container image with global registry when specified
    template: frontend/deployment.yaml
    set:
      global:
        imageRegistry: global-registry.example.com
      deploymentMode: distributed
      frontend:
        image:
          repository: hoppscotch/hoppscotch-frontend
          tag: latest
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].image
          value: global-registry.example.com/hoppscotch/hoppscotch-frontend:latest

  - it: should set container image with component registry when specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        image:
          registry: component-registry.example.com
          repository: hoppscotch/hoppscotch-frontend
          tag: latest
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].image
          value: component-registry.example.com/hoppscotch/hoppscotch-frontend:latest

  - it: should set container image pull policy when specified
    template: frontend/deployment.yaml
    set:
      deploymentMode: distributed
      frontend:
        image:
          pullPolicy: Always
    asserts:
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
